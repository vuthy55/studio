
# Sync Online Changelog

All notable changes to the Sync Online feature will be documented in this file.

## [Unreleased]

### Added
- **`[IMPROVEMENT]`** To better support our international testing community, a Khmer-language version of the "Beta Tester Information" is now available on the homepage. This provides clear, native-language guidance for our Cambodian testers, ensuring they have the same quality of information as our English-speaking participants.
- **`[IMPROVEMENT]`** Enhanced the main marketing page by replacing the "Beta Test (English)" link with an interactive dialog. This allows prospective testers to view the Beta Tester Information directly on the homepage without navigating away, creating a more seamless and user-friendly experience.
- **`[IMPROVEMENT]`** Implemented a comprehensive reporting and moderation system for the Common Room. This feature empowers the community and administrators to maintain a safe and respectful environment.
    - **User Reporting:** Any user can now report a Vibe that they believe violates community guidelines. The report action is available in the Vibe's participant list.
    - **Automated Workflow:** When a report is submitted, the system automatically:
        1.  Creates a formal report document in the database for admin review.
        2.  Places the reported Vibe "under review," making its content temporarily inaccessible to non-admin users to prevent further issues.
        3.  Sends in-app notifications to all system administrators, alerting them to the new report.
        4.  Sends a private notification to the creator of the Vibe, informing them that their content is under review.
        5.  Sends a confirmation to the reporter that their submission was received.
    - **Admin Moderation Panel:** A new "Reports" tab is available in the Admin Dashboard, which lists all pending and resolved reports for easy tracking.
    - **In-Context Review:** Admins can click on any report to navigate directly to the Vibe's conversation, allowing them to see the reported content in its original context.
    - **AI Investigator (AII):** A new AI-powered tool is available to admins within the reported Vibe. The AII analyzes the entire conversation against the established community rules, provides a summary judgment, and highlights specific posts that may be in violation, dramatically speeding up the review process.
    - **Moderation Actions & Soft Deletion:** From the Vibe view, admins can take action via a streamlined dropdown menu:
        - **Dismiss:** If no violation is found, the report is dismissed, the Vibe is reactivated, and both the reporter and creator are notified.
        - **Archive (Soft Deletion):** If a violation is found, the admin can "Archive" the Vibe. This is a soft delete that makes the Vibe permanently inaccessible to all regular users but preserves the content in the database for administrative records and future reference. The reporter and creator are notified of the action taken.
- **`[IM_PROVEMENT]`** Implemented Phase 1 of the "Common Room / Vibes" feature enhancement. This major update significantly improves usability and management.
    - **Post Translation:** Users can now translate any post in a Vibe into their default language for a small token fee. Translations are permanently saved to the post, so the community only pays once per language.
    - **Automatic Language Detection:** The translation feature now automatically detects the source language of a post instead of assuming it is English.
    - **Vibe Search:** A search bar has been added to the Common Room, allowing users to quickly find public Vibes by keywords in their topics.
    - **Creator Deletion:** Vibe creators now have the ability to permanently delete their own Vibes and all associated content.
    - **Auto-Subscription:** When a user posts a reply in a public Vibe for the first time, they are automatically "subscribed" to it, causing the Vibe to appear in their personalized "My Vibes" list for easy follow-up.
- **`[IMPROVEMENT]`** Enhanced the user login flow for non-registered users. Instead of displaying a generic error message, the system now detects a failed login, presents a user-friendly toast notification explaining the issue, and provides a one-click action to switch to the sign-up form with the user's email pre-filled, streamlining the registration process.
- **`[IMPROVEMENT]`** Implemented a major performance refactoring of the Admin Dashboard to address extremely slow Hot Module Replacement (HMR) times, which were taking up to 30 seconds for minor changes.
    - **Problem:** The application's development performance had degraded significantly, violating the core principle of a "fast and simple" architecture.
    - **Root Cause:** The `AdminPageV2.tsx` component had become a monolithic file containing the logic for all admin tabs. This forced the build system (Turbopack) to re-process the entire large component and its dependency graph on every minor change.
    - **Solution:** The monolithic component was broken down into smaller, independent modules. Each tab's content (e.g., `UsersTab`, `SettingsTab`) was extracted into its own file within a new `src/app/admin/components/` directory. The main `AdminPageV2.tsx` now acts as a lightweight shell, simply importing and assembling these modular pieces. This architectural change restored HMR performance, reducing rebuild times from tens of seconds to a few hundred milliseconds.
- **`[IMPROVEMENT]`** Improved the Common Room layout by centering the main navigation tabs on mobile devices and repositioning the "Take a Tour" button for better visibility.
- **`[IMPROVEMENT]`** Redesigned the "InfoHub Management" section in the Admin Dashboard for clarity and control. The new interface separates AI source configuration from the country database view into distinct tabs. It also introduces a powerful "Build/Update Database" feature, allowing administrators to selectively research and add countries by region, rather than being forced to build the entire world database at once. The database view itself has been overhauled into an accordion layout for improved readability and easier editing of individual country data.
- **`[IMPROVEMENT]`** Confirmed and documented the stability of the Sync Live billing logic. The system operates on a real-time, pay-as-you-go model where users first consume a free monthly minute allowance. Once the free minutes are exhausted, the `UserDataContext` correctly deducts tokens on a per-minute basis for any subsequent usage, ensuring accurate and immediate transaction handling.
- **`[IMPROVEMENT]`** Implemented a fully responsive, mobile-first design for the Sync Online room interface. On desktop, the layout features a persistent two-panel view with the participant list on the left and the main chat area on the right. On mobile devices, the interface collapses into a single view where the chat area is primary, and the participant list becomes a slide-in "sheet" accessible via an icon button in the header. This ensures an optimal and intuitive user experience across all screen sizes.
- **`[IMPROVEMENT]`** Refined the session timer logic in Sync Online rooms. The timer now starts only upon the first microphone press by any participant, ensuring that billing and usage tracking are based purely on active conversation time rather than time spent idle in the room. This provides a more fair and accurate measure of session duration.
- **`[IMPROVEMENT]`** Implemented an intelligent redirection flow for new users signing up via a Sync Room invite. The `signUpUser` server action now inspects the room's status during sign-up. New users are only redirected into the room if it is currently active; otherwise, they are safely routed to their profile page, preventing any potential client-side permission errors and creating a more logical user experience.
- **`[IMPROVEMENT]`** To enhance user trust and transparency, a confirmation dialog was added before a user spends tokens to translate a Vibe post. The dialog clearly states the action and its token cost, requiring the user to explicitly approve the transaction before it proceeds.
- **`[IMPROVEMENT]`** Removed the redundant "Archived Vibes" feature from the Admin Dashboard. Since inactive vibes are already sorted to the bottom of the "Active Common Rooms" list, this change simplifies the UI, streamlines the admin workflow, and significantly improves the initial load of the Rooms tab by removing an expensive database query.

### Fixed
- **`[FIX]`** Resolved a critical user creation failure for new users signing up via Google. The sign-up flow has been re-architected to be a two-step process. First, Google authenticates the user. If they are new, they are then presented with a "complete profile" form to provide necessary details (e.g., country, default language). Only after submitting this form is the `signUpUser` server action called, which now creates the Firebase Auth record and the Firestore user document in a single, atomic transaction. This guarantees that all new users are correctly registered with all required information.
- **`[FIX]`** Corrected the visibility of the "Donate" button in the main sidebar. It was previously visible to all users, including those who were not logged in. The button will now only appear for authenticated users, aligning with the requirement that donations be tied to a specific user account for record-keeping.
- **`[FIX]`** Resolved a `TypeError: settings.tabManager._initialize is not a function` build error caused by an incorrect Firebase cache initialization. Replaced the deprecated `enableIndexedDbPersistence()` function with the modern `initializeFirestore()` and `persistentSingleTabManager`, ensuring the app builds correctly and uses the latest Firebase v11 API for offline data caching.
- **`[FIX]`** Fixed a routing issue where the "Register Now" button on the main marketing page did not take users to the sign-up form. The login page now correctly respects the `?tab=signup` URL parameter to show the appropriate form on load.
- **`[FIX]`** Overhauled the offline language pack architecture to resolve multiple critical regressions and improve performance.
    - **Inefficient Regeneration:** Fixed a major performance issue where the client was re-generating language packs via expensive AI calls on every download, instead of fetching the pre-built packs from storage. The system now correctly downloads the pre-generated data, significantly reducing costs and load times.
    - **Purchase & Unlock Flow:** Restored the regressed feature allowing users to unlock paid language packs with tokens. The UI now correctly displays an "Unlock" button for locked packs, and the transaction is handled atomically on the server.
    - **Unwanted Re-downloads:** Resolved a bug where the system would automatically re-download language packs that a user had intentionally deleted. The app now uses a `downloadedPacks` array in the user's profile to respect their choices.
    - **Mobile Responsiveness:** Fixed a UI bug where the language pack download dialog was not responsive on mobile devices, causing the top and bottom to be cut off. The dialog now correctly adapts to screen size by using a flexible layout, ensuring all content is visible and scrollable.
- **`[FIX]`** Resolved a series of critical, cascading build failures that prevented application deployment. The root causes were a combination of fundamental TypeScript type errors and incorrect handling of Next.js server-side rendering (SSR) versus client-side rendering (CSR) logic. Key issues included:
    - **Client-Side API Misuse:** Multiple pages (`/admin`, `/login`, `/profile`, `/feedback`) were attempting to access browser-only APIs (`window.location`, `useSearchParams`) during the server-side build process, leading to `ReferenceError` and `missing-suspense-with-csr-bailout` errors. The definitive fix involved restructuring these pages to isolate all client-dependent logic into dedicated child components, which were then wrapped in a React `<Suspense>` boundary. This ensures that server-side pre-rendering can complete successfully while client-side components load as intended.
    - **TypeScript Type Safety Violations:** Several modules contained type mismatches that blocked compilation. This included importing types from incorrect files, extending interfaces with incompatible properties (e.g., a server-side `FieldValue` vs. a client-side `Date` object for timestamps), and incorrectly defining context provider types that did not account for all possible states (`undefined` in addition to `User | null`). These were resolved by correcting import paths and ensuring type definitions accurately reflected their data structures.
    - **SDK Usage Errors:** Incorrect property names were used when handling errors from the Azure Speech SDK (e.g., `cancellation.ErrorCode`), leading to multiple failed builds. This was resolved by consulting the SDK's documentation and using the correct property names (`AuthenticationFailure`). This reinforces the need for careful API verification over assumption.
- **`[FIX]`** Resolved a series of build-blocking dependency and type-safety issues. This included adding the `cmdk` library required by the command component and correcting the type definitions for the `@paypal/paypal-js` package to ensure the `OnApproveData` type was correctly imported. These fixes resolved the final TypeScript errors that were preventing a successful build.
- **`[FIX]`** Resolved multiple, cascading build failures by addressing several root causes in the codebase. This included:
    - **Upgrading Deprecated Libraries:** Replaced the unsupported `@paypal/checkout-server-sdk` with a modern, `fetch`-based API implementation, resolving a critical type definition error that blocked all builds.
    - **Correcting Type Mismatches:** Fixed numerous TypeScript errors where the data shape returned by a function did not match its defined type. This involved correcting the return value of the `getReportsAdmin` function to align with the `ClientReport` type and ensuring AI flow schemas (e.g., in `summarize-room-flow.ts`) correctly matched their expected output interfaces.
    - **Resolving Import Errors:** Fixed invalid import statements for Firebase Admin SDK functions (`FieldValue`, `serverTimestamp`) across multiple server-side action files, ensuring the correct modules were referenced.
- **`[FIX]`** Resolved a critical and persistent race condition where a Sync Online room would fail to close and reconcile when the last participant left. This resulted in the room appearing "active" indefinitely and the session timer continuing to run, leading to potential overcharging and incorrect state.
    - **Root Cause:** The `handleParticipantExit` server action attempted to call the `endAndReconcileRoom` function from *within* a Firestore transaction. This either violated Firestore's "reads after writes" rule (causing the transaction to fail silently) or created a race condition where the room's state wasn't updated before the reconciliation logic ran.
    - **Definitive Solution:** The logic was refactored to be robust and atomic. The `handleParticipantExit` function's transaction now only determines if the leaving user is the last one. If so, it completes its transaction (deleting the user) and *then* makes a separate, subsequent call to the `endAndReconcileRoom` function. This separation of concerns ensures the participant count is accurate before the settlement logic is triggered, guaranteeing reliable room closure and financial reconciliation every time.
- **`[FIX]`** Resolved a race condition that could cause a `permission-denied` error when a creator deleted their own Vibe. The logic now mirrors other successful fixes in the app by ensuring all client-side Firestore listeners for the Vibe and its posts are detached *before* the server action to delete the Vibe is called, preventing the client from trying to access a document that no longer exists.
- **`[FIX]`** Resolved an issue where language packs that were purchased and then deleted by the user would not reappear in the "Available for Download" list. The logic now ensures that any unlocked language pack is always available for a free re-download, correctly respecting the user's purchase history.
- **`[FIX]`** Resolved a critical page rendering failure across multiple pages (including `/infohub`, `/stats`, and `/profile`) that caused `504 Gateway Timeout` errors or browser freezes in an infinite loop. The root cause was a race condition where client-side components attempted to fetch user-specific data before the application had confirmed the user's authentication status. This was definitively resolved by enforcing a standard pattern across all pages to conditionally render page content only *after* the `useUserData` hook confirms an active user session, preventing any unauthenticated server calls from being made.
- **`[FIX]`** Resolved a major performance bottleneck in the Common Room that caused slow load times, especially as the number of "Vibes" grew. The root cause was an N+1 query problem where the app made a separate database call for every Vibe to fetch its upcoming meetups. The definitive fix involved a two-part strategy:
    1.  **Resilient Server-Side Query:** The data-fetching logic was re-architected to first attempt a high-performance `collectionGroup` query to get all meetups in a single call. Crucially, this is wrapped in a `try...catch` block. If the required database index is not yet ready, the system automatically falls back to the slower, but reliable, per-Vibe fetching method, ensuring the page always loads.
    2.  **Client-Side Caching:** Implemented a browser-side caching layer using IndexedDB. The app now instantly loads data from the cache on repeat visits for a significantly faster user experience, while fetching fresh data in the background.
- **`[FIX]`** Resolved a persistent and critical `npm ERESOLVE` dependency conflict that blocked all builds and installations. The root cause was an inability for `npm` to find a compatible version of key packages like `genkit` and `undici` that satisfied all peer dependency requirements throughout the complex dependency tree. This was exacerbated by transient dependencies (dependencies of dependencies) requesting non-existent or conflicting versions.
    - **Initial Problem:** Using caret (`^`) versioning for packages allowed `npm` to install newer minor versions, but this flexibility led to dependency tree conflicts where sub-dependencies had incompatible requirements.
    - **Resolution Strategy:** After several unsuccessful attempts to align versions, the definitive solution involved a two-pronged approach to enforce strict version control:
        1.  **Version Pinning:** All `genkit`-related packages (`genkit`, `@genkit-ai/googleai`, `genkit-cli`) were pinned to a specific, known-stable version (`1.14.1`) in `package.json` by removing the `^` version specifier.
        2.  **Using Overrides:** An `overrides` block was added to `package.json`. This powerful feature instructs `npm` to use specific versions for `genkit` and `undici` for all packages across the entire dependency tree, overriding any conflicting requests from transient dependencies.
    - This combination eliminated all version ambiguity, successfully resolved the `ERESOLVE` and `ETARGET` errors, and stabilized the build process.
- **`[FIX]`** Resolved a recurring "Invalid Query" and "permission-denied" error during Sync Room creation. The definitive fix involved removing a faulty and insecure client-side query from the `handleSubmitRoom` function that was incorrectly attempting to look up users. All user lookup and notification logic is now correctly and solely handled by the secure `sendRoomInviteEmail` server action.
- **`[FIX]`** Resolved an inconsistent distance calculation bug in the "Common Room" feature. The "Parties Near Me" function was producing unreliable and fluctuating distance results due to a race condition. The root cause was that the UI state was being updated individually and prematurely as each asynchronous location lookup completed, rather than waiting for all of them to finish. The definitive fix involved refactoring the logic to use `Promise.all`, which ensures that the component waits for every meetup's location to be resolved and every distance to be calculated before committing a single, final update to the UI. This guarantees a stable and accurate sorting of meetups by distance.
- **`[FIX]`** Resolved a recurring data serialization error in the "Common Room" feature that caused the page to crash (`Only plain objects...can be passed to Client Components`). The root cause was that documents in the `vibes` collection contained unexpected `Timestamp` fields that were not being properly converted to a serializable format before being sent from the server action to the client component. The definitive fix involved implementing a robust sanitization loop in the `getVibes` server action that dynamically inspects every field of a fetched document and converts any `Timestamp` object it finds into a plain ISO string, making the data fetching resilient to schema inconsistencies.
- **`[FIX]`** Resolved a series of cascading failures in the InfoHub AI Agent. The agent was initially providing dangerously incorrect travel advisories (e.g., a 9/10 safety score for Myanmar during a civil war) and unhelpful empty results for safe countries. The root causes were a combination of a naive date filter discarding valid long-term advisories, inconsistent API search results, and a flawed "safe country" fallback logic. The definitive fix involved re-architecting the agent to be more resilient. It now uses an intelligent, two-tiered data gathering approach: it first attempts a targeted web search, and if that fails to return critical advisory data, it falls back to directly scraping the official government source. This ensures the AI receives reliable, verified information, allowing it to generate accurate and nuanced safety assessments.
- **`[FIX]`** Overhauled the Admin Dashboard tab navigation by replacing the flawed custom button implementation with a standard, responsive `TabsList` component. The previous implementation suffered from incorrect state management, causing the active tab not to be visually highlighted, and a non-responsive grid layout. The new structure, modeled after the working SyncHub component, fixes all layout and interactivity issues.
- **`[FIX]`** Overhauled the Sync Online billing and reconciliation logic to resolve multiple critical financial errors. The system now correctly ensures that only the room creator is billed for usage. Previously, participants were being incorrectly charged on a per-minute basis, and in scenarios where a refund was due for unused time, the refund was being incorrectly issued to all participants instead of just the creator. Both issues have been definitively resolved, ensuring financial accuracy.
- **`[FIX]`** Resolved a persistent `FirebaseError: The query requires an index` error when fetching the user's referral list. The query in `getReferredUsers` has been refactored to perform a simple filter on the server and handle sorting on the client-side, eliminating the need for a composite index and ensuring reliable data fetching.
- **`[FIX]`** Resolved a critical race condition that caused a `permission-denied` error upon exiting a Sync Online room. The root cause was that client-side Firestore listeners remained active for a moment after the user's participant record was deleted on the server. The fix ensures that all Firestore listeners within the component (`participants` and `messages`) are manually and synchronously detached *before* the server action to exit the room is called. This guarantees the client stops listening before its permissions are revoked, fully resolving the error. The logic for emcee hand-off and last-participant-out room closure has been confirmed as stable and correct.
- **`[FIX]`** Resolved a regression where referral records were not being created in the `referrals` collection upon user signup, although the referrer correctly received their bonus tokens. The issue was caused by a misplaced batch operation that overwrote the referral creation command before it could be committed to the database. The logic in the `signUpUser` action has been corrected to ensure all referral-related database writes are executed atomically and correctly.
- **`[FIX]`** Resolved a complex regression causing all microphone-based features (`Live Translation`, `Prep Your Vibe`, `Sync Live`) to fail after the first use. The root cause was a flawed state management change in a shared speech recognition service, which created a race condition between the service's internal cleanup and the component's lifecycle cleanup hooks. This resulted in unpredictable behavior, including infinite loops and audio stream leaks. The solution involved standardizing the architecture: the shared service is now solely responsible for the recognition task, while the calling components are responsible for managing the resource lifecycle (creation and cleanup), ensuring a predictable and stable behavior across the entire application.
- **`[FIX]`** Resolved a critical regression where live translations in Sync Online rooms were failing. Participants were hearing the original untranslated audio instead of the audio in their selected language. The issue was traced to an incorrect helper function being used after a code refactoring, which caused the translation step to be skipped. The fix ensures the correct language code format is passed to the translation service, restoring real-time translation functionality.
- **`[FIX]`** Resolved a race condition where the Profile page would display empty fields for `country` and `language` after login, even when data existed in Firestore. The component's local state was initializing with empty data before the user's profile was fully loaded from the central `UserDataContext`. The fix eliminated the problematic local state and now binds the form fields directly to the `UserDataContext`, ensuring the UI is always a direct reflection of the central data store.
- **`[FIX]`** Resolved a persistent `FirebaseError: Missing or insufficient permissions` error that occurred upon user logout. The root cause was a race condition where data-fetching hooks (`fetchUserProfile`) were called after the user's authentication state was cleared but before the component tree fully updated. The fix involved centralizing logout logic in the `UserDataContext` and implementing a state guard to immediately and synchronously block any user-specific data fetches the moment a logout is initiated.
- **`[FIX]`** Resolved an infinite loop that occurred when an emcee ended a meeting. A state guard now prevents the component from repeatedly trying to exit, ensuring a clean navigation away from the closed room.
- **`[FIX]`** Resolved a persistent race condition on room entry that caused a "permission denied" error when listening for messages. The logic is now separated to ensure the message listener is only initialized *after* the user's participant status is confirmed, which also resolves the downstream WebChannel errors upon exit.
- **`[FIX]`** Corrected a `ReferenceError` for `where` not being defined by adding the proper import from `firebase/firestore`.
- **`[FIX]`** Prevented old messages from being loaded when a user joins or rejoins a room by querying for messages created after the user's join timestamp.
- **`[FIX]`** Corrected a series of build-blocking issues, including a dependency conflict with PayPal packages and several TypeScript type errors related to incorrect prop usage (`title` on an icon instead of a `Tooltip`) and mismatched function signatures (passing an object with `id` to a function expecting `uid`). Resolved a React hydration error by delaying the rendering of user-specific links until the client has mounted, ensuring server and client HTML match on initial load.




    






