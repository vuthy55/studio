# Sync Online Changelog

All notable changes to the Sync Online feature will be documented in this file.

## [Unreleased]

### Added
- **`[IMPROVEMENT]`** Redesigned the Sync Online meeting room to be fully mobile-responsive. On mobile devices, the participant panel now collapses into a slide-in sheet, prioritizing the chat and microphone controls.
- **`[IMPROVEMENT]`** Refined the meeting room UI by relocating the session timer to the header. Detailed cost and balance information is now available in a tooltip on the clock, creating a cleaner interface.
- **`[FIX]`** Corrected the session timer logic in Sync Online rooms. The timer and associated token billing now correctly start only upon the first press of the microphone button, rather than on room entry, ensuring users are only charged for active participation.
- **`[IMPROVEMENT]`** Updated the "Exit Room" and "End Meeting" functions to redirect users to the Sync Online tab within the SyncHub, providing a more logical and seamless user experience.
- **`[IMPROVEMENT]`** Implemented an intelligent redirection flow for new users signing up via a Sync Room invite. The `signUpUser` server action now inspects the room's status during sign-up. New users are only redirected into the room if it is currently active; otherwise, they are safely routed to their profile page, preventing any potential client-side permission errors and creating a more logical user experience.

### Fixed
- **`[FIX]`** Corrected a critical regression in the referral system where new referral records were not being created in the `referrals` collection upon user signup. The issue was caused by a faulty database batching implementation in the `signUpUser` server action, which prevented the referral document from being committed. The logic has been restored to its correct, original state, ensuring all referral data is now saved atomically and accurately.
- **`[FIX]`** Resolved a complex regression causing all microphone-based features (`Live Translation`, `Prep Your Vibe`, `Sync Live`) to fail after the first use. The root cause was a flawed state management change in a shared speech recognition service, which created a race condition between the service's internal cleanup and the component's lifecycle cleanup hooks. This resulted in unpredictable behavior, including infinite loops and audio stream leaks. The solution involved standardizing the architecture: the shared service is now solely responsible for the recognition task, while the calling components are responsible for managing the resource lifecycle (creation and cleanup), ensuring a predictable and stable behavior across the entire application.
- **`[FIX]`** Resolved a critical regression where live translations in Sync Online rooms were failing. Participants were hearing the original untranslated audio instead of the audio in their selected language. The issue was traced to an incorrect helper function being used after a code refactoring, which caused the translation step to be skipped. The fix ensures the correct language code format is passed to the translation service, restoring real-time translation functionality.
- **`[FIX]`** Resolved a persistent `FirebaseError: The query requires an index` error when fetching the user's referral list. The issue was traced to an unreliable deployment of composite indexes. The query in `getReferredUsers` has been refactored to perform a simple filter on the server and handle sorting on the client-side, eliminating the need for a composite index and ensuring reliable data fetching.
- **`[FIX]`** Resolved a race condition where the Profile page would display empty fields for `country` and `language` after login, even when data existed in Firestore. The component's local state was initializing with empty data before the user's profile was fully loaded from the central `UserDataContext`. The fix eliminated the problematic local state and now binds the form fields directly to the `UserDataContext`, ensuring the UI is always a direct reflection of the central data store.
- **`[FIX]`** Resolved a persistent `FirebaseError: Missing or insufficient permissions` error that occurred upon user logout. The root cause was a race condition where data-fetching hooks (`fetchUserProfile`) were called after the user's authentication state was cleared but before the component tree fully updated. The fix involved centralizing logout logic in the `UserDataContext` and implementing a state guard to immediately and synchronously block any user-specific data fetches the moment a logout is initiated.
- **`[FIX]`** Resolved an infinite loop that occurred when an emcee ended a meeting. A state guard now prevents the component from repeatedly trying to exit, ensuring a clean navigation away from the closed room.
- **`[FIX]`** Resolved a persistent race condition on room entry that caused a "permission denied" error when listening for messages. The logic is now separated to ensure the message listener is only initialized *after* the user's participant status is confirmed, which also resolves the downstream WebChannel errors upon exit.
- **`[FIX]`** Corrected a `ReferenceError` for `where` not being defined by adding the proper import from `firebase/firestore`.
- **`[FIX]`** Prevented old messages from being loaded when a user joins or rejoins a room by querying for messages created after the user's join timestamp.
